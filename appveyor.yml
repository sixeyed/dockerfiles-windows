version: '{build}'

image: Visual Studio 2017

environment:
  DOCKER_USER:
    secure: LJxMxZl1dCKgMF5FlErnwQ==
  DOCKER_PASS:
    secure: HASfuLeqW86zydzpb7/5Zg==
  DOCKER_IMAGE_NAME: idubnori/elasticsearch:6.4.0-nanoserver-sac2016

init:
#  - ps: docker version
#  - ps: docker info
  - ps: docker images
#  - ps: |
#      cinst curl -y --no-progress
#      sal curl (Join-Path $env:ChocolateyInstall "bin\curl.exe") -O AllScope

build_script:
  - ps: |
      cd $env:APPVEYOR_BUILD_FOLDER
      cd .\elasticsearch\nanoserver\sac2016
      docker build -t $env:DOCKER_IMAGE_NAME .
      docker images

test_script:
  - ps: |
      $cid = docker run -d $env:DOCKER_IMAGE_NAME
      $hostip = docker inspect -f "{{ .NetworkSettings.Networks.nat.IPAddress }}" $cid
      Start-Sleep -s 45
      Write-Host "Fetching HTTP at container IP: $hostip"
      $response = iwr -useb "http://${hostip}:9200/_cat/health"
      $health = $response.Content.Split(' ')[3]
      if ($response.StatusCode -eq 200 -and ($health -eq 'green' -or $health -eq 'yellow')) {
          Write-Host "Test passed - Elasticsearch is running, health: $health"
      } else {
          Write-Host "Test failed"
          exit 1
      }

deploy_script:
  - ps: |
      echo $env:DOCKER_PASS | docker login -u $env:DOCKER_USER --password-stdin
      docker push $env:DOCKER_IMAGE_NAME